name: Update Jira Issue on Push

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æœ‰äºº Push åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œ
on:
  push:
    branches:
      - main

jobs:
  update-jira:
    runs-on: ubuntu-latest
    name: Auto Transition Jira Issue
    steps:
      # 1. ç™»å…¥ Jira (ä½¿ç”¨æ‚¨åœ–ç‰‡ä¸­ä¸‹åŠéƒ¨çš„ atlassian/gajira-login)
      - name: Login to Jira
        uses: atlassian/gajira-login@master
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 2. å°‹æ‰¾ Jira å–®è™Ÿ (å¾ Commit è¨Šæ¯ä¸­è‡ªå‹•æŠ“å–ï¼Œä¾‹å¦‚ "MCTT-123 fixed bug")
      - name: Find Issue Key
        id: find
        uses: atlassian/gajira-find-issue-key@master
        with:
          string: ${{ github.event.head_commit.message }}

      # 3. æ›´æ–° Jira ç‹€æ…‹ (å°æ‡‰æ‚¨åœ–ç‰‡ä¸­çš„ atlassian/gajira-transition)
      # ä¾‹å¦‚ï¼šç•¶ç¨‹å¼ç¢¼åˆä½µå¾Œï¼ŒæŠŠå¡ç‰‡ç§»å‹•åˆ° "Done"
      - name: Transition Issue to Done
        uses: atlassian/gajira-transition@master
        if: steps.find.outputs.issue != ''  # åªæœ‰æ‰¾åˆ°å–®è™Ÿæ™‚æ‰åŸ·è¡Œ
        with:
          issue: ${{ steps.find.outputs.issue }}
          transition: "Done"  # é€™è£¡å¡«å¯«æ‚¨ Jira çœ‹æ¿ä¸Šçš„ç‹€æ…‹åç¨± (ä¾‹å¦‚ "In Progress" æˆ– "Done")

      # 4. (é¸ç”¨) æ›´æ–°å…¶ä»–æ¬„ä½ (å°æ‡‰æ‚¨åœ–ç‰‡ä¸­ä¸ŠåŠéƒ¨çš„æ›´æ–°åŠŸèƒ½)
      # å¯ä»¥åœ¨é€™è£¡ç•™è¨€å‘Šè¨´ PM èªªå·²ç¶“éƒ¨ç½²äº†
      - name: Comment on Issue
        uses: atlassian/gajira-comment@master
        if: steps.find.outputs.issue != ''
        with:
          issue: ${{ steps.find.outputs.issue }}
          comment: "ğŸš€ ç¨‹å¼ç¢¼å·²è‡ªå‹•éƒ¨ç½²åˆ° Main åˆ†æ”¯ï¼"
